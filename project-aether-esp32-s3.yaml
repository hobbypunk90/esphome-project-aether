substitutions:
  i2c_sda: GPIO1
  i2c_scl: GPIO2

  spi_mosi: GPIO12
  spi_clk: GPIO11

  display_cs: GPIO10
  display_dc: GPIO9
  display_reset: GPIO8
  display_busy: GPIO7

  led_pin: GPIO13
  led_rgb_order: GRB
  led_chipset: WS2812
  led_count: 1

  shtcx_address: 0x70
  ens160_address: 0x52
  sps30_address: 0x69
  scd4x_address: 0x62
  bmp280_address: 0x76


esphome:
  name: air-quality
  friendly_name: Indoor Air Quality
  # Automatically add the mac address to the name
  # so you can use a single firmware for all devices
  name_add_mac_suffix: true
  project:
    name: hobbypunk90.Aether
    version: dev
  includes:
    - helpers/display.h
  on_boot:
    - priority: 600
      then:
        - display.page.show: boot_page
        - component.update: primary_display

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

packages:
  diagnostics: !include
    file: common/diagnostics.yaml

# To be able to get logs from the device via serial and api.
logger:

# API is a requirement of the dashboard import.
api:
  id: api_default

# OTA is required for Over-the-Air updating
ota:
  - platform: esphome

wifi:
  # Set up a wifi access point using the device name above
  ap:

# In combination with the `ap` this allows the user
# to provision wifi credentials to the device.
captive_portal:


font:
  - id: header_font
    size: 20
    file:
      type: gfonts
      family: Roboto
    extras:
      file: 
        url: https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/tags/v7.4.47/fonts/materialdesignicons-webfont.ttf
        type: web
      glyphs:
        - "\U000F1511" # mdi:access-point-off
        - "\U000F0003" # mdi:access-point
        - "\U000F0928" # mdi:wifi-strength-4
        - "\U000F0925" # mdi:wifi-strength-3
        - "\U000F0922" # mdi:wifi-strength-2
        - "\U000F091F" # mdi:wifi-strength-1
        - "\U000F092F" # mdi:wifi-strength-outline
        - "\U000F092E" # mdi:wifi-strength-off-outline
  - id: page_filling_icons
    size: 120
    file:
      url: https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/tags/v7.4.47/fonts/materialdesignicons-webfont.ttf
      type: web
    glyphs:
      - "\U000F07D0" # mdi:home-assistant
      - "\U000F06B0" # mdi:update
  - id: font_default
    size: 50
    file:
      type: gfonts
      family: Roboto

  - id: font_big_integer
    size: 112
    file:
      type: gfonts
      family: Roboto
  - id: font_big_decimal
    size: 44
    file:
      type: gfonts
      family: Roboto
    extras:
      file:
        url: https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/tags/v7.4.47/fonts/materialdesignicons-webfont.ttf
        type: web
      glyphs:
        - "\U000F050F" # mdi:thermometer
        - "\U000F032A" # mdi:leaf

  - id: font_small_integer
    size: 56
    file:
      type: gfonts
      family: Roboto
  - id: font_small_decimal
    size: 24
    file:
      type: gfonts
      family: Roboto
    extras:
      file:
        url: https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/tags/v7.4.47/fonts/materialdesignicons-webfont.ttf
        type: web
      glyphs:
        - "\U000F058C" # mdi:water
  - id: font_second_page_small
    size: 24
    file:
      type: gfonts
      family: Roboto
    glyphsets:
      - GF_Latin_Core
    glyphs:
      - "µ"
      - "³"
    extras:
      file:
        url: https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/tags/v7.4.47/fonts/materialdesignicons-webfont.ttf
        type: web
      glyphs:
        - "\U000F0D7C" # PM  mdi:grain
        - "\U000F07E4" # CO² mdi:molecule-co2
        - "\U000F0095" # VOC mdi:flask-empty-outline

time:
  - platform: sntp
    id: time1
i2c:
  sda: ${i2c_sda}
  scl: ${i2c_scl}
  scan: true
spi:
  mosi_pin: ${spi_mosi}
  clk_pin: ${spi_clk}

sensor:
  # Hardware Sensors
  - platform: shtcx
    address: ${shtcx_address}
    temperature:
      id: temperature
      name: Temperatur
      icon: 'mdi:thermometer'
      filters: 
        - sliding_window_moving_average:
            window_size: 3
            send_every: 1
        - offset: !lambda return id(temperature_offset).state;
        - or:
            - delta: 0.1
            - heartbeat: 600s
    humidity: 
      id: humidity
      name: Luftfeuchtigkeit
      icon: 'mdi:water-percent'
      filters:
        - sliding_window_moving_average:
            window_size: 3
            send_every: 1
        - offset: !lambda return id(humidity_offset).state;
        - or:
            - delta: 0.1
            - heartbeat: 600s
    update_interval: 5s
  - platform: ens160_i2c
    address: ${ens160_address}
    eco2:
      name: eCO2
    tvoc:
      id: voc
      name: VOC
      on_value: 
        then:
          - sensor.template.publish:
                id: iaqi_voc
                state: !lambda |-
                  if (             x <=   400) return 100.0 + ((81.0 - 100.0) /              400.0 ) * (x);
                  if (  400 < x && x <=  1500) return  80.0 + ((61.0 -  80.0) / ( 1500.0 -   400.0)) * (x -   400);
                  if ( 1500 < x && x <=  5000) return  60.0 + ((41.0 -  60.0) / ( 5000.0 -  1500.0)) * (x -  1500);
                  if ( 5000 < x && x <= 20000) return  40.0 + ((21.0 -  40.0) / (20000.0 -  5000.0)) * (x -  5000);
                  if (20000 < x && x <= 50000) return  20.0 + (( 0.0 -  20.0) / (50000.0 - 20000.0)) * (x - 20000);
                  return -1;
    compensation:
      temperature: temperature
      humidity: humidity
    update_interval: 15s
  - platform: sps30
    address: ${sps30_address}
    update_interval: 15s
    auto_cleaning_interval: 345600s # 4d
    pm_1_0:
      id: pm_1_0
      name: "Feinstaub <1µm"
      on_value: 
        then:
          - sensor.template.publish:
                id: iaqi_pm_1_0
                state: !lambda |-
                  float value = -1;
                  
                  if (x <= 15)                 value = 100.0 + ((81.0 - 100.0) /          15.0 ) * (x);
                  else if (15 < x && x <= 35)  value =  80.0 + ((61.0 -  80.0) / ( 35.0 - 15.0)) * (x - 15);
                  else if (35 < x && x <= 62)  value =  60.0 + ((41.0 -  60.0) / ( 62.0 - 35.0)) * (x - 35);
                  else if (62 < x && x <= 96)  value =  40.0 + ((21.0 -  40.0) / ( 96.0 - 62.0)) * (x - 62);
                  else if (96 < x && x <= 150) value =  20.0 + (( 0.0 -  20.0) / (150.0 - 96.0)) * (x - 96);
                  return (int)round(value);
    pm_2_5:
      id: pm_2_5
      name: "Feinstaub <2.5µm"
      on_value: 
        then:
          - sensor.template.publish:
                id: iaqi_pm_2_5
                state: !lambda |-
                  float value = -1;
                  
                  if ( x <= 21)                 value = 100.0 + ((81.0 - 100.0) /           21.0 ) *(x);
                  else if ( 21 < x && x <= 51)  value =  80.0 + ((61.0 -  80.0) / ( 51.0 -  21.0)) *( x -  21);
                  else if ( 51 < x && x <= 91)  value =  60.0 + ((41.0 -  60.0) / ( 91.0 -  51.0)) *( x -  51);
                  else if ( 91 < x && x <= 141) value =  40.0 + ((21.0 -  40.0) / (141.0 -  91.0)) *( x -  91);
                  else if (141 < x && x <= 200) value =  20.0 + (( 0.0 -  20.0) / (200.0 - 141.0)) *( x - 141);
                  return (int)round(value);
    pm_4_0:
      name: "Feinstaub <4µm"
      disabled_by_default: True
    pm_10_0:
      id: pm_10_0
      name: "Feinstaub <10µm"
      on_value: 
        then:
          - sensor.template.publish:
                id: iaqi_pm_10_0
                state: !lambda |-
                  float value = -1;

                  if ( x <= 31)                 value = 100.0 + ((81.0 - 100.0) /           31.0 ) * (x);
                  else if ( 31 < x && x <= 76)  value =  80.0 + ((61.0 -  80.0) / ( 76.0 -  31.0)) * (x -  31);
                  else if ( 76 < x && x <= 126) value =  60.0 + ((41.0 -  60.0) / (126.0 -  76.0)) * (x -  76);
                  else if (126 < x && x <= 201) value =  40.0 + ((21.0 -  40.0) / (201.0 - 126.0)) * (x - 126);
                  else if (201 < x && x <= 300) value =  20.0 + (( 0.0 -  20.0) / (300.0 - 201.0)) * (x - 201);
                  return (int)round(value);
    pmc_0_5:
      name: "Partikelanzahl <0.5µm"
      disabled_by_default: True
    pmc_1_0:
      name: "Partikelanzahl <1µm"
      disabled_by_default: True
    pmc_2_5:
      name: "Partikelanzahl <2.5µm"
      disabled_by_default: True
    pmc_4_0:
      name: "Partikelanzahl <4µm"
      disabled_by_default: True
    pmc_10_0:
      name: "Partikelanzahl <10µm"
      disabled_by_default: True
  - platform: scd4x
    id: scd41
    address: ${scd4x_address}
    update_interval: 15s
    ambient_pressure_compensation_source: pressure
    co2:
      name: CO2
      id: co2
      on_value: 
        then:
          - sensor.template.publish:
                id: iaqi_co2
                state: !lambda |-
                  if (            x <=  600) return 100.0 + ((81.0 - 100.0) /            600.0 ) * (x);
                  if ( 600 < x && x <= 1000) return  80.0 + ((61.0 -  80.0) / (1000.0 -  600.0)) * (x - 600);
                  if (1000 < x && x <= 1500) return  60.0 + ((41.0 -  60.0) / (1500.0 - 1000.0)) * (x - 1000);
                  if (1500 < x && x <= 2500) return  40.0 + ((21.0 -  40.0) / (2500.0 - 1500.0)) * (x - 1500);
                  if (2500 < x && x <= 4000) return  20.0 + (( 0.0 -  20.0) / (4000.0 - 2500.0)) * (x - 2500);
                  return -1;
  - platform: bmp280_i2c
    address: ${bmp280_address}
    update_interval: 15s
    pressure:
      id: pressure
      name: Luftdruck

  # iAQI Sensors
  - name: iAQI CO2
    id: iaqi_co2
    icon: mdi:leaf
    platform: template
    disabled_by_default: True
    update_interval: never
    accuracy_decimals: 0
    device_class: aqi
    filters:
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true
  - name: iAQI VOC
    id: iaqi_voc
    icon: mdi:leaf
    platform: template
    disabled_by_default: True
    update_interval: never
    accuracy_decimals: 0
    device_class: aqi
    filters:
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true
  - name: iAQI Feinstaub <1.0µm
    id: iaqi_pm_1_0
    icon: mdi:leaf
    platform: template
    disabled_by_default: True
    update_interval: never
    accuracy_decimals: 0
    device_class: aqi
    filters:
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true
  - name: iAQI Feinstaub <2.5µm
    id: iaqi_pm_2_5
    icon: mdi:leaf
    platform: template
    disabled_by_default: True
    update_interval: never
    accuracy_decimals: 0
    device_class: aqi
    filters:
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true
  - name: iAQI Feinstaub <10µm
    id: iaqi_pm_10_0
    icon: mdi:leaf
    platform: template
    disabled_by_default: True
    update_interval: never
    accuracy_decimals: 0
    device_class: aqi
    filters:
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true
  - name: iAQI
    id: iaqi
    icon: mdi:leaf
    platform: template
    accuracy_decimals: 0
    device_class: aqi
    filters:
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true
      - sliding_window_moving_average:
          window_size: 12
          send_every: 1
    on_value:
      then:
        - light.turn_on:
            id: iaqi_led
            brightness: !lambda return id(led_brightness).state / 100.0;
            red: !lambda |-
              float s = x; // x ist der aktuelle Score (0-100)
              // Logik für ROT-Kanal
              if (s >= 80) return 0.0;   // Grün -> Kein Rot
              if (s >= 60) return 0.6;   // Gelb/Lime -> Etwas Rot
              if (s >= 40) return 1.0;   // Orange -> Voll Rot
              if (s >= 20) return 1.0;   // Rot -> Voll Rot
              return 0.6;                // Lila (Gefahr) -> Etwas Rot
            green: !lambda |-
              float s = x;
              // Logik für GRÜN-Kanal
              if (s >= 80) return 1.0;   // Grün -> Voll Grün
              if (s >= 60) return 1.0;   // Gelb/Lime -> Voll Grün
              if (s >= 40) return 0.5;   // Orange -> Halb Grün
              return 0.0;                // Rot/Lila -> Kein Grün
            blue: !lambda |-
              float s = x;
              // Logik für BLAU-Kanal (nur für Lila bei extrem schlechter Luft)
              if (s < 20) return 1.0;    // Lila -> Voll Blau
              return 0.0;                // Sonst kein Blau
            transition_length: 2s
text_sensor:
  - name: iAQI Quelle
    id: iaqi_source
    icon: mdi:leaf
    platform: template
    disabled_by_default: True
    update_interval: 5s
    lambda: !lambda |-
      int s_voc     = id(iaqi_voc).state;
      int s_co2     = id(iaqi_co2).state;
      int s_pm_1_0  = id(iaqi_pm_1_0).state;
      int s_pm_2_5  = id(iaqi_pm_2_5).state;
      int s_pm_10_0 = id(iaqi_pm_10_0).state;
      
      if (!isnan(s_voc) || !isnan(s_co2) || !isnan(s_pm_1_0) || !isnan(s_pm_2_5) || !isnan(s_pm_10_0) || !isnan(s_pm_10_0)) {
        if (isnan(s_voc)) s_voc = 100;
        if (isnan(s_co2)) s_co2 = 100;
        if (isnan(s_pm_1_0)) s_pm_1_0 = 100;
        if (isnan(s_pm_2_5)) s_pm_2_5 = 100;
        if (isnan(s_pm_10_0)) s_pm_10_0 = 100;

        int min = std::min({s_voc, s_co2, s_pm_1_0, s_pm_2_5, s_pm_10_0});

        if (min == s_voc) return {"VOC"};
        if (min == s_co2) return {"CO2"};
        if (min == s_pm_1_0) return {"PM1.0"};
        if (min == s_pm_2_5) return {"PM2.5"};
        if (min == s_pm_10_0) return {"PM10.0"};
      }
      return {"invalid"};
    on_value:
      then:
        - lambda: |-
            if (x == "VOC") {
              id(iaqi).publish_state(id(iaqi_voc).state);
            } else if (x == "CO2") {
              id(iaqi).publish_state(id(iaqi_co2).state);
            } else if (x == "PM1.0") {
              id(iaqi).publish_state(id(iaqi_pm_1_0).state);
            } else if (x == "PM2.5") {
              id(iaqi).publish_state(id(iaqi_pm_2_5).state);
            } else if (x == "PM10.0") {
              id(iaqi).publish_state(id(iaqi_pm_10_0).state);
            }
interval:
  - interval: 2.5s
    then:
      - component.update: primary_display
  - interval: 20s
    then:
      - if:
          condition:
            lambda: |-
              return !isnan(id(iaqi).state);
          then:
            - display.page.show: clean_page
            - component.update: primary_display
            - select.next: pages
            - component.update: primary_display

light:
  - platform: esp32_rmt_led_strip
    rgb_order: ${led_rgb_order}
    pin: ${led_pin}
    num_leds: ${led_count}
    name: iAQI LED
    id: iaqi_led
    chipset: ${led_chipset}
    restore_mode: ALWAYS_OFF

number:
  - name: LED Helligkeit
    id: led_brightness
    platform: template
    entity_category: "config"
    initial_value: 30
    min_value: 0
    max_value: 100
    step: 5
    unit_of_measurement: "%"
    optimistic: True
    restore_value: True
    on_value:
      if:
        condition:
          light.is_on: iaqi_led
        then:
          - light.turn_on:
              id: iaqi_led
              brightness: !lambda return id(led_brightness).state / 100.0;

  - name: Temperatur Offset
    id: temperature_offset
    platform: template
    entity_category: "config"
    initial_value: 1.5
    min_value: -10.0
    max_value: 10.0
    step: 0.1
    unit_of_measurement: "°C"
    optimistic: True
    restore_value: True
  - name: Luftfeuchtigkeit Offset
    id: humidity_offset
    platform: template
    entity_category: "config"
    initial_value: 0
    min_value: -10.0
    max_value: 10.0
    step: 0.1
    unit_of_measurement: "%"
    optimistic: True
    restore_value: True
  - name: CO2 Kalibrierungswert
    id: co2_calibration_value
    platform: template
    entity_category: "config"
    initial_value: 430
    min_value: 0
    max_value: 2000
    step: 1
    unit_of_measurement: "ppm"
    optimistic: True
    restore_value: True

button:
  - platform: template
    name: "CO2 Kalibrierung"
    id: co2_calibration_btn
    icon: "mdi:auto-fix"
    entity_category: config
    on_press:
      - logger.log: 
          format: "Starte manuelle Kalibrierung auf %.0f ppm..."
          args: [ 'id(co2_calibration_value).state' ]
      - scd4x.perform_forced_calibration:
          id: scd41
          value: !lambda return id(co2_calibration_value).state;
      - delay: 2s

select:
  - name: Pages
    platform: template
    id: pages
    entity_category: "diagnostic"
    options:
      - first_page
      - second_page
    initial_option: second_page
    optimistic: True
    on_value: 
      - display.page.show: !lambda |-
          std::string current = x;
          if (current == "first_page") {
            return id(first_page);
          } else {
            return id(second_page);
          }

display:
  - platform: waveshare_epaper
    id: primary_display
    rotation: 180°
    cs_pin: ${display_cs}
    dc_pin: ${display_dc}
    reset_pin: ${display_reset}
    busy_pin: ${display_busy}
    model: 1.54inv2
    update_interval: never
    full_update_every: 600
    pages:
      - id: first_page
        lambda: !lambda |-
          Page page(it);

          int upper_height = page.get_height()/2 + 5;
          std::string integer_text;
          std::string decimal_text;
          int area_center;
          int text_width;

          {
            Container area(page, 0, 0, page.get_width(), upper_height);

            int gap_x = 2;
            int gap_y = 7;
            float value = id(temperature).state;
            if (isnan(value)) {
              integer_text = "-";
              decimal_text = "";
            } else {
              integer_text = str_sprintf("%d", (int)value);
              decimal_text = str_sprintf(".%d", abs((int)(value * 10) % 10));
            }
            
            auto integer_width = area.get_text_width(id(font_big_integer), integer_text.c_str());
            auto decimal_width = area.get_text_width(id(font_big_decimal), decimal_text.c_str());
            auto decimal_height = area.get_cap_height(id(font_big_decimal));

            text_width = integer_width + gap_x + decimal_width;
            
            area_center = area.get_width() / 2;

            area.print(area_center - text_width/2,                             area.get_height(),                            id(font_big_integer), TextAlign::BASELINE_LEFT, integer_text.c_str());
            area.print(area_center - text_width/2 + integer_width + gap_x,     area.get_height(),                            id(font_big_decimal), TextAlign::BASELINE_LEFT, decimal_text.c_str());
            area.print(area_center - text_width/2 + integer_width + gap_x + 3, area.get_height() - (decimal_height + gap_y), id(font_big_decimal), TextAlign::BASELINE_LEFT, "\U000F050F");
          }

          //page.line(0, upper_height + 5, page.get_width(), upper_height + 5);

          {
            Container area(page, 0, upper_height + 10, page.get_width(), page.get_height() - (upper_height + 10));

            int gap_x = 2;
            int gap_y = 1;

            float value = id(humidity).state;
            if (isnan(value)) {
              integer_text = "-";
              decimal_text = "";
            } else {
              integer_text = str_sprintf("%d", (int)value);
              decimal_text = str_sprintf(".%d", abs((int)(value * 10) % 10));
            }

            auto integer_width = area.get_text_width(id(font_small_integer), integer_text.c_str());
            auto decimal_width = area.get_text_width(id(font_small_decimal), decimal_text.c_str());
            auto decimal_height = area.get_cap_height(id(font_small_decimal));
            auto y = area.get_height() - 15;

            text_width = integer_width + gap_x + decimal_width;
            
            area_center = area.get_width() / 2;

            area.print(area_center - text_width/2,                         y,                            id(font_small_integer), TextAlign::BASELINE_LEFT, integer_text.c_str());
            area.print(area_center - text_width/2 + integer_width + gap_x, y,                            id(font_small_decimal), TextAlign::BASELINE_LEFT, decimal_text.c_str());
            area.print(area_center - text_width/2 + integer_width + gap_x, y - (decimal_height + gap_y), id(font_small_decimal), TextAlign::BASELINE_LEFT, "\U000F058C");
          }
      - id: second_page
        lambda: !lambda |-
          Page page(it);

          int upper_height = page.get_height()/2 + 15;
          int area_center;
          int text_width;
          std::string integer_text;

          float iaqi_s = id(iaqi).state;

          {
            Container area(page, 0, 0, page.get_width(), upper_height);
            int gap_x = 2;
            int gap_y = 7;

            if (isnan(iaqi_s)) {
              integer_text = "-";
            } else {
              integer_text = str_sprintf("%d", (int)iaqi_s);
            }
            const char* unit_text = "\U000F032A";
                        
            auto integer_width = area.get_text_width(id(font_big_integer), integer_text.c_str());
            auto unit_width = area.get_text_width(id(font_big_decimal), unit_text);
            auto decimal_height = area.get_cap_height(id(font_big_decimal));

            text_width = integer_width + gap_x + unit_width;
            
            area_center = area.get_width() / 2;

            area.print(area_center - text_width/2,                             area.get_height(),                            id(font_big_integer), TextAlign::BASELINE_LEFT, integer_text.c_str());
            area.print(area_center - text_width/2 + integer_width + gap_x + 3, area.get_height() - (decimal_height + gap_y), id(font_big_decimal), TextAlign::BASELINE_LEFT, unit_text);

          }

          //page.line(0, upper_height + 5, page.get_width(), upper_height + 5);
          {
            Container area(page, 0, upper_height + 10, page.get_width(), page.get_height() - (upper_height + 10));

            if (!isnan(iaqi_s)) {
              integer_text = "";

              if (id(iaqi_source).state == "VOC") {
                integer_text = str_sprintf("%s %.0f ppb", "\U000F0095", id(voc).state);
              } else if (id(iaqi_source).state == "CO2") {
                integer_text = str_sprintf("%s %.0f ppm", "\U000F07E4", id(co2).state);
              } else if (id(iaqi_source).state == "PM1.0") {
                integer_text = str_sprintf("%s %.0f µg/m³", "\U000F0D7C", id(pm_1_0).state);
              } else if (id(iaqi_source).state == "PM2.5") {
                integer_text = str_sprintf("%s %.0f µg/m³", "\U000F0D7C", id(pm_2_5).state);
              } else if (id(iaqi_source).state == "PM10.0") {
                integer_text = str_sprintf("%s %.0f µg/m³", "\U000F0D7C", id(pm_10_0).state);
              }
              auto integer_width = area.get_text_width(id(font_second_page_small), integer_text.c_str());
              area.print((area.get_width() - integer_width) / 2, area.get_height() - 15, id(font_second_page_small), TextAlign::BASELINE_LEFT, integer_text.c_str());
            }
          }
      - id: boot_page
        lambda: !lambda |-
          BootPage boot_page(it);
      - id: clean_page
        lambda: !lambda |-
          Page page(it);
          page.filled_rectangle(0, 0, page.get_width(), page.get_height(), COLOR_OFF);
