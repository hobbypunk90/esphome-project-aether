esphome:
  name: air-quality
  friendly_name: Indoor Air Quality
  # Automatically add the mac address to the name
  # so you can use a single firmware for all devices
  name_add_mac_suffix: true
  project:
    name: hobbypunk90.Aether
    version: dev
  includes:
    - helpers/display.h
  on_boot:
    - priority: 600
      then:
        - display.page.show: boot_page
        - component.update: primary_display

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

packages:
  diagnostics: !include
    file: common/diagnostics.yaml

# To be able to get logs from the device via serial and api.
logger:

# API is a requirement of the dashboard import.
api:
  id: api_default

# OTA is required for Over-the-Air updating
ota:
  - platform: esphome

wifi:
  # Set up a wifi access point using the device name above
  ap:

# In combination with the `ap` this allows the user
# to provision wifi credentials to the device.
captive_portal:


font:
  - id: header_font
    size: 20
    file:
      type: gfonts
      family: Roboto
    extras:
      file: 
        url: https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/tags/v7.4.47/fonts/materialdesignicons-webfont.ttf
        type: web
      glyphs:
        - "\U000F1511" # mdi:access-point-off
        - "\U000F0003" # mdi:access-point
        - "\U000F0928" # mdi:wifi-strength-4
        - "\U000F0925" # mdi:wifi-strength-3
        - "\U000F0922" # mdi:wifi-strength-2
        - "\U000F091F" # mdi:wifi-strength-1
        - "\U000F092F" # mdi:wifi-strength-outline
        - "\U000F092E" # mdi:wifi-strength-off-outline
  - id: page_filling_icons
    size: 120
    file:
      url: https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/tags/v7.4.47/fonts/materialdesignicons-webfont.ttf
      type: web
    glyphs:
      - "\U000F07D0" # mdi:home-assistant
      - "\U000F06B0" # mdi:update
  - id: font_default
    size: 50
    file:
      type: gfonts
      family: Roboto

  - id: font_big_integer
    size: 112
    file:
      type: gfonts
      family: Roboto
  - id: font_big_decimal
    size: 44
    file:
      type: gfonts
      family: Roboto
    extras:
      file:
        url: https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/tags/v7.4.47/fonts/materialdesignicons-webfont.ttf
        type: web
      glyphs:
        - "\U000F050F" # mdi:thermometer
        - "\U000F032A" # mdi:leaf

  - id: font_small_integer
    size: 56
    file:
      type: gfonts
      family: Roboto
  - id: font_small_decimal
    size: 24
    file:
      type: gfonts
      family: Roboto
    extras:
      file:
        url: https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/tags/v7.4.47/fonts/materialdesignicons-webfont.ttf
        type: web
      glyphs:
        - "\U000F058C" # mdi:water
  - id: font_second_page_small
    size: 24
    file:
      type: gfonts
      family: Roboto
    glyphsets:
      - GF_Latin_Core
    glyphs:
      - "µ"             # Das Mikro-Zeichen
      - "³"             # Die hochgestellte Drei
    extras:
      file:
        url: https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/tags/v7.4.47/fonts/materialdesignicons-webfont.ttf
        type: web
      glyphs:
        - "\U000F0D7C" # PM  mdi:grain
        - "\U000F07E4" # CO² mdi:molecule-co2
        - "\U000F0095" # VOC mdi:flask-empty-outline

time:
  - platform: sntp
    id: time1
i2c:
  sda: GPIO1
  scl: GPIO2
  scan: true
spi:
  mosi_pin: GPIO12
  clk_pin: GPIO11

sensor:
  - platform: shtcx
    address: 0x70
    temperature:
      id: temperature
      name: Temperatur
      icon: 'mdi:thermometer'
    humidity: 
      id: humidity
      name: Luftfeuchtigkeit
      icon: 'mdi:water-percent'
    update_interval: 5s
  - platform: ens160_i2c
    address: 0x52
    eco2:
      name: eCO2
    tvoc:
      id: voc
      name: VOC
      # output = output_start + ((output_end - output_start) / (input_end - input_start)) * (input - input_start)
      on_value: 
        then:
          - sensor.template.publish:
                id: iaqi_voc
                state: !lambda |-
                  if (           x <= 200) return 100.0 + ((81.0 - 100.0) /          200.0 ) * (x);
                  if (200 < x && x <= 250) return  80.0 + ((61.0 -  80.0) / (250.0 - 200.0)) * (x - 200);
                  if (250 < x && x <= 350) return  60.0 + ((41.0 -  60.0) / (350.0 - 250.0)) * (x - 250);
                  if (350 < x && x <= 400) return  40.0 + ((21.0 -  40.0) / (400.0 - 350.0)) * (x - 350);
                  if (400 < x && x <= 500) return  20.0 + (( 0.0 -  20.0) / (500.0 - 400.0)) * (x - 400);
                  return -1;
    compensation:
      temperature: temperature
      humidity: humidity
    update_interval: 15s
  - platform: sps30
    address: 0x69
    update_interval: 15s
    auto_cleaning_interval: 345600s # 4d
    pm_1_0:
      id: pm_1_0
      name: "Feinstaub <1µm"
      # output = output_start + ((output_end - output_start) / (input_end - input_start)) * (input - input_start)
      on_value: 
        then:
          - sensor.template.publish:
                id: iaqi_pm_1_0
                state: !lambda |-
                  float value = -1;
                  
                  if (x <= 15)                 value = 100.0 + ((81.0 - 100.0) /          15.0 ) * (x);
                  else if (15 < x && x <= 35)  value =  80.0 + ((61.0 -  80.0) / ( 35.0 - 15.0)) * (x - 15);
                  else if (35 < x && x <= 62)  value =  60.0 + ((41.0 -  60.0) / ( 62.0 - 35.0)) * (x - 35);
                  else if (62 < x && x <= 96)  value =  40.0 + ((21.0 -  40.0) / ( 96.0 - 62.0)) * (x - 62);
                  else if (96 < x && x <= 150) value =  20.0 + (( 0.0 -  20.0) / (150.0 - 96.0)) * (x - 96);
                  return (int)round(value);
    pm_2_5:
      id: pm_2_5
      name: "Feinstaub <2.5µm"
      on_value: 
        then:
          - sensor.template.publish:
                id: iaqi_pm_2_5
                state: !lambda |-
                  float value = -1;
                  
                  if ( x <= 21)                 value = 100.0 + ((81.0 - 100.0) /           21.0 ) *(x);
                  else if ( 21 < x && x <= 51)  value =  80.0 + ((61.0 -  80.0) / ( 51.0 -  21.0)) *( x -  21);
                  else if ( 51 < x && x <= 91)  value =  60.0 + ((41.0 -  60.0) / ( 91.0 -  51.0)) *( x -  51);
                  else if ( 91 < x && x <= 141) value =  40.0 + ((21.0 -  40.0) / (141.0 -  91.0)) *( x -  91);
                  else if (141 < x && x <= 200) value =  20.0 + (( 0.0 -  20.0) / (200.0 - 141.0)) *( x - 141);
                  return (int)round(value);
    pm_4_0:
      name: "Feinstaub <4µm"
      disabled_by_default: True
    pm_10_0:
      id: pm_10_0
      name: "Feinstaub <10µm"
      on_value: 
        then:
          - sensor.template.publish:
                id: iaqi_pm_10_0
                state: !lambda |-
                  float value = -1;

                  if ( x <= 31)                 value = 100.0 + ((81.0 - 100.0) /           31.0 ) * (x);
                  else if ( 31 < x && x <= 76)  value =  80.0 + ((61.0 -  80.0) / ( 76.0 -  31.0)) * (x -  31);
                  else if ( 76 < x && x <= 126) value =  60.0 + ((41.0 -  60.0) / (126.0 -  76.0)) * (x -  76);
                  else if (126 < x && x <= 201) value =  40.0 + ((21.0 -  40.0) / (201.0 - 126.0)) * (x - 126);
                  else if (201 < x && x <= 300) value =  20.0 + (( 0.0 -  20.0) / (300.0 - 201.0)) * (x - 201);
                  return (int)round(value);
    pmc_0_5:
      name: "Partikelanzahl <0.5µm"
      disabled_by_default: True
    pmc_1_0:
      name: "Partikelanzahl <1µm"
      disabled_by_default: True
    pmc_2_5:
      name: "Partikelanzahl <2.5µm"
      disabled_by_default: True
    pmc_4_0:
      name: "Partikelanzahl <4µm"
      disabled_by_default: True
    pmc_10_0:
      name: "Partikelanzahl <10µm"
      disabled_by_default: True
  - platform: scd4x
    co2:
      name: CO2
      id: co2
      # output = output_start + ((output_end - output_start) / (input_end - input_start)) * (input - input_start)
      on_value: 
        then:
          - sensor.template.publish:
                id: iaqi_co2
                state: !lambda |-
                  if (            x <=  600) return 100.0 + ((81.0 - 100.0) /            600.0 ) * (x);
                  if ( 600 < x && x <= 1000) return  80.0 + ((61.0 -  80.0) / (1000.0 -  600.0)) * (x - 600);
                  if (1000 < x && x <= 1500) return  60.0 + ((41.0 -  60.0) / (1500.0 - 1000.0)) * (x - 1000);
                  if (1500 < x && x <= 2500) return  40.0 + ((21.0 -  40.0) / (2500.0 - 1500.0)) * (x - 1500);
                  if (2500 < x && x <= 4000) return  20.0 + (( 0.0 -  20.0) / (4000.0 - 2500.0)) * (x - 2500);
                  return -1;
    address: 0x62
    update_interval: 15s
    ambient_pressure_compensation_source: pressure
  - platform: bmp280_i2c
    pressure:
      id: pressure
      name: Luftdruck
    address: 0x76
    update_interval: 15s

  - name: iAQI CO2
    id: iaqi_co2
    icon: mdi:leaf
    platform: template
    disabled_by_default: True
    update_interval: never
    accuracy_decimals: 0
    device_class: aqi
    filters:
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true
  - name: iAQI VOC
    id: iaqi_voc
    icon: mdi:leaf
    platform: template
    disabled_by_default: True
    update_interval: never
    accuracy_decimals: 0
    device_class: aqi
    filters:
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true
  - name: iAQI Feinstaub <1.0µm
    id: iaqi_pm_1_0
    icon: mdi:leaf
    platform: template
    disabled_by_default: True
    update_interval: never
    accuracy_decimals: 0
    device_class: aqi
    filters:
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true
  - name: iAQI Feinstaub <2.5µm
    id: iaqi_pm_2_5
    icon: mdi:leaf
    platform: template
    disabled_by_default: True
    update_interval: never
    accuracy_decimals: 0
    device_class: aqi
    filters:
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true
  - name: iAQI Feinstaub <10µm
    id: iaqi_pm_10_0
    icon: mdi:leaf
    platform: template
    disabled_by_default: True
    update_interval: never
    accuracy_decimals: 0
    device_class: aqi
    filters:
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true
  - name: iAQI
    id: iaqi
    icon: mdi:leaf
    platform: template
    update_interval: 5s
    accuracy_decimals: 0
    device_class: aqi
    filters:
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true
      - sliding_window_moving_average:
          window_size: 12
          send_every: 1
    lambda: !lambda |-
      int s_voc     = id(iaqi_voc).state;
      int s_co2     = id(iaqi_co2).state;
      int s_pm_1_0  = id(iaqi_pm_1_0).state;
      int s_pm_2_5  = id(iaqi_pm_2_5).state;
      int s_pm_10_0 = id(iaqi_pm_10_0).state;

      if (isnan(s_voc) && isnan(s_co2) && isnan(s_pm_1_0) && isnan(s_pm_2_5) && isnan(s_pm_10_0) && isnan(s_pm_10_0)) {
         return {}; // Wartet wirklich auf den allerersten Wert
      }

      if (isnan(s_voc)) s_voc = 100.0;
      if (isnan(s_co2)) s_co2 = 100.0;
      if (isnan(s_pm_1_0)) s_pm_1_0 = 100.0;
      if (isnan(s_pm_2_5)) s_pm_2_5 = 100.0;
      if (isnan(s_pm_10_0)) s_pm_10_0 = 100.0;

      return std::min({s_voc, s_co2, s_pm_1_0, s_pm_2_5, s_pm_10_0});
    on_value:
      then:
        - light.turn_on:
            id: iaqi_led
            # Helligkeit: 30% reicht meistens indoor völlig aus
            brightness: 30% 
            red: !lambda |-
              float s = x; // x ist der aktuelle Score (0-100)
              // Logik für ROT-Kanal
              if (s >= 80) return 0.0;   // Grün -> Kein Rot
              if (s >= 60) return 0.6;   // Gelb/Lime -> Etwas Rot
              if (s >= 40) return 1.0;   // Orange -> Voll Rot
              if (s >= 20) return 1.0;   // Rot -> Voll Rot
              return 0.6;                // Lila (Gefahr) -> Etwas Rot
            green: !lambda |-
              float s = x;
              // Logik für GRÜN-Kanal
              if (s >= 80) return 1.0;   // Grün -> Voll Grün
              if (s >= 60) return 1.0;   // Gelb/Lime -> Voll Grün
              if (s >= 40) return 0.5;   // Orange -> Halb Grün
              return 0.0;                // Rot/Lila -> Kein Grün
            blue: !lambda |-
              float s = x;
              // Logik für BLAU-Kanal (nur für Lila bei extrem schlechter Luft)
              if (s < 20) return 1.0;    // Lila -> Voll Blau
              return 0.0;                // Sonst kein Blau
            transition_length: 2s

interval:
  - interval: 2.5s
    then:
      - component.update: primary_display
  - interval: 20s
    then:
      - if:
          condition:
            lambda: |-
              return !isnan(id(iaqi).state);
          then:
            - display.page.show: clean_page
            - component.update: primary_display
            - select.next: pages
            - component.update: primary_display

light:
  - platform: esp32_rmt_led_strip
    rgb_order: GRB
    pin: GPIO13
    num_leds: 1
    name: iAQI LED
    id: iaqi_led
    chipset: WS2812
    restore_mode: ALWAYS_OFF

select:
  - name: Pages
    platform: template
    id: pages
    entity_category: "diagnostic"
    options:
      - first_page
      - second_page
    initial_option: second_page
    optimistic: True
    on_value: 
      - display.page.show: !lambda |-
          std::string current = x;
          if (current == "first_page") {
            return id(first_page);
          } else {
            return id(second_page);
          }

display:
  - platform: waveshare_epaper
    id: primary_display
    rotation: 180°
    cs_pin: GPIO10
    dc_pin: GPIO9
    reset_pin: GPIO8
    busy_pin: GPIO7
    model: 1.54inv2
    update_interval: never
    full_update_every: 600
    pages:
      - id: first_page
        lambda: !lambda |-
          Page page(it);

          int upper_height = page.get_height()/2 + 5;
          std::string integer_text;
          std::string decimal_text;
          int area_center;
          int text_width;

          {
            Container area(page, 0, 0, page.get_width(), upper_height);

            int gap_x = 2;
            int gap_y = 7;
            float value = id(temperature).state;
            if (isnan(value)) {
              integer_text = "-";
              decimal_text = "";
            } else {
              integer_text = str_sprintf("%d", (int)value);
              decimal_text = str_sprintf(".%d", abs((int)(value * 10) % 10));
            }
            
            auto integer_width = area.get_text_width(id(font_big_integer), integer_text.c_str());
            auto decimal_width = area.get_text_width(id(font_big_decimal), decimal_text.c_str());
            auto decimal_height = area.get_cap_height(id(font_big_decimal));

            text_width = integer_width + gap_x + decimal_width;
            
            area_center = area.get_width() / 2;

            area.print(area_center - text_width/2,                             area.get_height(),                            id(font_big_integer), TextAlign::BASELINE_LEFT, integer_text.c_str());
            area.print(area_center - text_width/2 + integer_width + gap_x,     area.get_height(),                            id(font_big_decimal), TextAlign::BASELINE_LEFT, decimal_text.c_str());
            area.print(area_center - text_width/2 + integer_width + gap_x + 3, area.get_height() - (decimal_height + gap_y), id(font_big_decimal), TextAlign::BASELINE_LEFT, "\U000F050F");
          }

          //page.line(0, upper_height + 5, page.get_width(), upper_height + 5);

          {
            Container area(page, 0, upper_height + 10, page.get_width(), page.get_height() - (upper_height + 10));

            int gap_x = 2;
            int gap_y = 1;

            float value = id(humidity).state;
            if (isnan(value)) {
              integer_text = "-";
              decimal_text = "";
            } else {
              integer_text = str_sprintf("%d", (int)value);
              decimal_text = str_sprintf(".%d", abs((int)(value * 10) % 10));
            }

            auto integer_width = area.get_text_width(id(font_small_integer), integer_text.c_str());
            auto decimal_width = area.get_text_width(id(font_small_decimal), decimal_text.c_str());
            auto decimal_height = area.get_cap_height(id(font_small_decimal));
            auto y = area.get_height() - 15;

            text_width = integer_width + gap_x + decimal_width;
            
            area_center = area.get_width() / 2;

            area.print(area_center - text_width/2,                         y,                            id(font_small_integer), TextAlign::BASELINE_LEFT, integer_text.c_str());
            area.print(area_center - text_width/2 + integer_width + gap_x, y,                            id(font_small_decimal), TextAlign::BASELINE_LEFT, decimal_text.c_str());
            area.print(area_center - text_width/2 + integer_width + gap_x, y - (decimal_height + gap_y), id(font_small_decimal), TextAlign::BASELINE_LEFT, "\U000F058C");
          }
      - id: second_page
        lambda: !lambda |-
          Page page(it);

          int upper_height = page.get_height()/2 + 15;
          int area_center;
          int text_width;
          std::string integer_text;

          float iaqi_s = id(iaqi).state;

          {
            Container area(page, 0, 0, page.get_width(), upper_height);
            int gap_x = 2;
            int gap_y = 7;

            if (isnan(iaqi_s)) {
              integer_text = "-";
            } else {
              integer_text = str_sprintf("%d", (int)iaqi_s);
            }
            const char* unit_text = "\U000F032A";
                        
            auto integer_width = area.get_text_width(id(font_big_integer), integer_text.c_str());
            auto unit_width = area.get_text_width(id(font_big_decimal), unit_text);
            auto decimal_height = area.get_cap_height(id(font_big_decimal));

            text_width = integer_width + gap_x + unit_width;
            
            area_center = area.get_width() / 2;

            area.print(area_center - text_width/2,                             area.get_height(),                            id(font_big_integer), TextAlign::BASELINE_LEFT, integer_text.c_str());
            area.print(area_center - text_width/2 + integer_width + gap_x + 3, area.get_height() - (decimal_height + gap_y), id(font_big_decimal), TextAlign::BASELINE_LEFT, unit_text);

          }

          //page.line(0, upper_height + 5, page.get_width(), upper_height + 5);
          {
            Container area(page, 0, upper_height + 10, page.get_width(), page.get_height() - (upper_height + 10));

            if (!isnan(iaqi_s)) {
              integer_text = "";
              int iaqi_voc_s = id(iaqi_voc).state;
              int iaqi_co2_s = id(iaqi_co2).state;
              int iaqi_pm_1_0_s = id(iaqi_pm_1_0).state;
              int iaqi_pm_2_5_s = id(iaqi_pm_2_5).state;
              int iaqi_pm_10_0_s = id(iaqi_pm_10_0).state;

              if (!isnan(iaqi_voc_s) && iaqi_voc_s     <= iaqi_s + 2) {
                // https://atmotube.com/blog/voc-concentrations-in-air-units-of-measurement
                integer_text = str_sprintf("%s %.2f mg/m³", "\U000F0095", 4.09 * id(voc).state);
              } else if (!isnan(iaqi_co2_s) && iaqi_co2_s     <= iaqi_s + 2) {
                integer_text = str_sprintf("%s %.0f ppm", "\U000F07E4", id(co2).state);
              } else if (!isnan(iaqi_pm_1_0_s) && iaqi_pm_1_0_s  <= iaqi_s + 2) {
                integer_text = str_sprintf("%s %.2f µg/m³", "\U000F0D7C", id(pm_1_0).state);
              } else if (!isnan(iaqi_pm_2_5_s) && iaqi_pm_2_5_s  <= iaqi_s + 2) {
                integer_text = str_sprintf("%s %.2f µg/m³", "\U000F0D7C", id(pm_2_5).state);
              } else if (!isnan(iaqi_pm_10_0_s) && iaqi_pm_10_0_s <= iaqi_s + 2) {
                integer_text = str_sprintf("%s %.2f µg/m³", "\U000F0D7C", id(pm_10_0).state);
              }
              auto integer_width = area.get_text_width(id(font_second_page_small), integer_text.c_str());
              area.print((area.get_width() - integer_width) / 2, area.get_height() - 15, id(font_second_page_small), TextAlign::BASELINE_LEFT, integer_text.c_str());
            }
          }
      - id: boot_page
        lambda: !lambda |-
          BootPage boot_page(it);
      - id: clean_page
        lambda: !lambda |-
          Page page(it);
          page.filled_rectangle(0, 0, page.get_width(), page.get_height(), COLOR_OFF);
